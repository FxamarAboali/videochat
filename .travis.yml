dist: bionic
before_script:
  - openssl aes-256-cbc -K $encrypted_key -iv $encrypted_iv -in ./.travis/id_rsa.enc -out ~/.ssh/id_rsa -d
  - chmod 600 ~/.ssh/id_rsa
  - "docker version"
  - "curl https://raw.githubusercontent.com/vishnubob/wait-for-it/8ed92e8cab83cfed76ff012ed4a36cef74b28096/wait-for-it.sh > ${TRAVIS_HOME}/gopath/bin/wait-for-it.sh && chmod +x ${TRAVIS_HOME}/gopath/bin/wait-for-it.sh"
matrix:
  include:
    - language: java
      jdk:
        - "openjdk11"
      cache:
        directories:
          - "/home/travis/.m2"
      before_install:
        - "java -version"
        - sudo apt update && sudo apt install -y chromium-browser
      install:
        - "/bin/true"
      script:
        - "docker-compose up -d"
        - "wait-for-it.sh -t 30 127.0.0.1:35432 -- echo 'postgres is up'"
        - "wait-for-it.sh -t 30 127.0.0.1:36379 -- echo 'redis is up'"
        - "rm ~/.m2/settings.xml"
        - (cd aaa; ./mvnw clean package -Dcustom.selenium.headless=true)
        - BUILDDIR=./build;
          WORKDIR=./aaa;
          IMAGE=nkonev/chat-aaa:latest;
          if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_TEST_RESULT" == "0" && "$TRAVIS_EVENT_TYPE" != "cron" ]]; then (
            cd $WORKDIR && mkdir -p $BUILDDIR && cp ./Dockerfile $BUILDDIR && cp target/*-exec.jar $BUILDDIR &&
            docker build -t $IMAGE $BUILDDIR &&
            echo "Will login to docker" &&
            docker login -u="$DOCKER_LOGIN" -p="$DOCKER_PASSWORD" &&
            echo "Will push docker image" &&
            docker push $IMAGE &&
            echo "Will deploy aaa" &&
            ssh -o "BatchMode yes" -o StrictHostKeyChecking=no -q $CONNECT_LINE $AAA_UPDATE_COMMAND
          ) else (
            echo "Won't push docker image and deploy";
          ) fi

    - language: javascript
      node_js:
        - "12.16.3"
      cache:
        directories:
          - "/home/travis/build/nkonev/videochat/frontend/node_modules"
      before_install:
        - "node --version"
      install:
        - "/bin/true"
      script:
        - "pwd"
        - (cd frontend; npm install && npm run build)
        - BUILDDIR=./build;
          WORKDIR=./frontend;
          IMAGE=nkonev/chat-frontend:latest;
          if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_TEST_RESULT" == "0" && "$TRAVIS_EVENT_TYPE" != "cron" ]]; then (
            cd $WORKDIR && mkdir -p $BUILDDIR && cp ./Dockerfile $BUILDDIR && cp -r ../frontend-nginx/* $BUILDDIR && cp ../docker/nginx/frontend.conf $BUILDDIR &&
            docker build -t $IMAGE $BUILDDIR &&
            echo "Will login to docker" &&
            docker login -u="$DOCKER_LOGIN" -p="$DOCKER_PASSWORD" &&
            echo "Will push docker image" &&
            docker push $IMAGE
          ) else (
            echo "Won't push docker image and deploy";
          ) fi

    - language: go
      sudo: required
      go:
        - "1.14.3"
      cache:
        directories:
          - "$GOPATH/pkg"
      before_install:
        - "go version"
      install:
        - "/bin/true"
      script:
        - pwd
        - go env
        - echo moving repository to flat directory struct
        - mv /home/travis/gopath/src/github.com/nkonev/videochat /home/travis/gopath
        - cd /home/travis/gopath/videochat
        - pwd
        - "go get github.com/rakyll/statik"
        - "docker-compose up -d"
        - "wait-for-it.sh -t 30 127.0.0.1:35432 -- echo 'postgres is up'"
        - "wait-for-it.sh -t 30 127.0.0.1:36379 -- echo 'redis is up'"
        - "wait-for-it.sh -t 30 127.0.0.1:9000 -- echo 'minio is up'"
        - sudo -- bash -c "echo '127.0.0.1   api.site.local' >> /etc/hosts"
        - "rm -rf ./chat/proto"
        - "mkdir ./chat/proto || true"
        - "docker run -it --rm -v $PWD:/ws -w /ws znly/protoc:0.4.0 --go_out=plugins=grpc:chat/proto -I./protobuf ./protobuf/*.proto"
        # https://medium.com/@diogok/on-golang-static-binaries-cross-compiling-and-plugins-1aed33499671
        - '(cd chat; export GIT_COMMIT=$(git rev-list -1 HEAD); echo "{\"commit\": \"$GIT_COMMIT\"}" > ./static/git.json)'
        - (cd chat; statik -src=./static -p static_assets -ns assets -f && statik -src=./db/migrations -p static_migrations -ns migrations -dest ./db -f && echo 'completed generating embed')
        - (cd chat; go test ./... -count=1 -test.v -test.timeout=20s -p 1)
        - (cd chat; CGO_ENABLED=0 go build -trimpath -ldflags '-w -extldflags "-static"')
        - '(cd storage; export GIT_COMMIT=$(git rev-list -1 HEAD); echo "{\"commit\": \"$GIT_COMMIT\"}" > ./static/git.json)'
        - (cd storage; statik -src=./static -p static_assets -ns assets -f && statik -src=./db/migrations -p static_migrations -ns migrations -dest ./db -f && echo 'completed generating embed')
        - (cd storage; go test ./... -count=1 -test.v -test.timeout=20s -p 1)
        - (cd storage; CGO_ENABLED=0 go build -trimpath -ldflags '-w -extldflags "-static"')

        - function buildAndPushGoDockerImage {
            if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_TEST_RESULT" == "0" && "$TRAVIS_EVENT_TYPE" != "cron" ]]; then (
              cd $WORKDIR && mkdir -p $BUILDDIR && mv $EXECUTABLE $BUILDDIR && cp ./Dockerfile $BUILDDIR &&
              docker build --build-arg BINARY=$EXECUTABLE -t $IMAGE $BUILDDIR &&
              echo "Will login to docker" &&
              docker login -u="$DOCKER_LOGIN" -p="$DOCKER_PASSWORD" &&
              echo "Will push docker image" &&
              docker push $IMAGE
            ) else (
              echo "Won't push docker image and deploy";
            ) fi
          }

        - BUILDDIR=./build;
          WORKDIR=./chat;
          EXECUTABLE=chat;
          IMAGE=nkonev/chat:latest;
          buildAndPushGoDockerImage;

        - BUILDDIR=./build;
          WORKDIR=./storage;
          EXECUTABLE=storage;
          IMAGE=nkonev/chat-storage:latest;
          buildAndPushGoDockerImage;